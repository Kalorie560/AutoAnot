# AutoAnot - 音声自動アノテーションシステム

AutoAnotは、音声の自動録音、アノテーション、データセット生成を行うStreamlitベースのアプリケーションです。音声を録音し、メトリクス変化に基づいてセグメントを自動的にラベル付けし、アノテーション付きデータをデータセットとして保存できます。

## 機能

- カスタマイズ可能なサンプリングレートと録音時間での音声録音
- メトリクス変化閾値に基づく1秒間隔の音声セグメント自動アノテーション
- カラーコード付きアノテーション（OK=緑、NG=赤）による音声波形の視覚的表示
- 各音声セグメントのメトリクス値表示（RMS、クルトシス、クレストファクタ）
- 機械学習アプリケーション用の.npzファイル形式でのデータセット生成・保存
- **ラベル手動編集機能**: 自動アノテーション後にOK/NGラベルの変更が可能
- **波形確認しながらのラベル編集**: 収録した信号波形を確認しながらラベル変更
- **視覚的編集フィードバック**: 手動編集されたラベルは太線と*印で表示
- **JSON変換機能**: NPZデータセットをJSON形式に変換可能
- **スタンドアロン変換ツール**: コマンドラインからのデータ形式変換

## 動作環境

- Python 3.x
- streamlit
- numpy
- sounddevice
- matplotlib
- scipy

## インストール

リポジトリをクローンし、必要な依存関係をインストールしてください：

```bash
# リポジトリのクローン
git clone <repository-url>
cd AutoAnot

# 仮想環境の作成と有効化（推奨）
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係のインストール
pip install streamlit numpy sounddevice matplotlib scipy
```

## 使用方法

1. アプリケーションの起動：

```bash
# 方法1: 提供されたスクリプトを使用
chmod +x run_app.sh
./run_app.sh

# 方法2: streamlitコマンドを直接実行
streamlit run app.py
```

2. Webインターフェースでの操作：
   - サンプリング周波数（Hz）を設定
   - 録音時間（秒）を設定
   - メトリクス変化閾値（%）を設定
   - 使用するメトリクス（RMS/クルトシス/クレストファクタ）を選択
   - 「録音開始」をクリックして録音開始
   - 録音後、自動アノテーションされたセグメントを確認
   - **ラベル手動編集セクション**で各セグメントのOK/NGラベルを変更
   - 「編集後のラベルで波形を更新」で変更内容を視覚的に確認
   - 「データセット保存」でアノテーション付きデータをdataset.npzファイルとして保存
   - **JSON変換**: 「dataset.npz → dataset.json 変換」でJSON形式への変換も可能

3. スタンドアロンでのJSON変換：
```bash
python convert_npz_to_json.py
```

## データセット形式

### NPZ形式（dataset.npz）
保存されるデータセットは.npz形式で、以下のコンポーネントを含みます：
- `waveforms`: 音声セグメントの配列（形状: セグメント数 × セグメント当たりのサンプル数）
- `labels`: 各セグメントの最終ラベル配列（"OK" または "NG"）※手動編集が反映
- `auto_labels`: 自動生成されたオリジナルのラベル配列（"OK" または "NG"）
- `fs`: 録音に使用されたサンプリング周波数
- `metric`: 使用されたメトリクスの種類

### JSON形式（dataset.json）
NPZデータと同じ内容をJSON形式で保存。機械学習フレームワークやWebアプリケーションでの利用に適しています。アプリ内の変換機能またはスタンドアロンスクリプト（`convert_npz_to_json.py`）で生成可能です。

## ファイル構成

- `app.py`: メインのStreamlitアプリケーション
- `run_app.sh`: アプリケーション起動スクリプト（サーバーアドレス: 192.168.249.1）
- `convert_npz_to_json.py`: NPZ→JSON変換用スタンドアロンスクリプト
- `dataset.npz`: 保存されたアノテーション付き音声データセット（実行後生成）
- `dataset.json`: JSON形式のデータセット（変換後生成）

## カスタマイズ

- **メトリクス感度調整**: 変化閾値（%）を変更して自動アノテーションの感度を調整
- **アプリロジック**: `app.py`を編集してアノテーションロジックや可視化パラメータを変更
- **サーバー設定**: `run_app.sh`のサーバーアドレス（現在：192.168.249.1）や追加のstreamlitパラメータを設定
- **変換スクリプト**: `convert_npz_to_json.py`で出力ファイル名や変換形式をカスタマイズ

## ライセンス

[ライセンスを指定してください]